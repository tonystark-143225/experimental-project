pipeline:
  name: diun
  identifier: diun
  projectIdentifier: appattendance
  orgIdentifier: default
  tags: {}
  stages:
    - stage:
        name: Check_Docker_Tags
        identifier: Check_Docker_Tags
        description: Check for new MySQL Docker tags and notify via email
        type: Custom
        spec:
          execution:
            steps:
              - step:
                  type: ShellScript
                  name: RunTagCheckScript
                  identifier: RunTagCheckScript
                  spec:
                    shell: Bash
                    source:
                      type: Inline
                      spec:
                        script: |
                          #!/bin/bash

                          # ========= Install jq if missing =========
                          if ! command -v jq &> /dev/null; then
                            echo "ðŸ“¦ Installing jq..."
                            if command -v microdnf &> /dev/null; then
                              microdnf install -y jq
                            elif command -v dnf &> /dev/null; then
                              dnf install -y jq
                            else
                              yum install -y jq
                            fi
                          fi

                          # ========= Configurable Variables =========
                          referenceTag="8.0"            # Tag to compare against
                          imageName="mysql"             # Docker image name
                          namespace="library"           # Use "library" for official images
                          pageSize=100                  # Number of tags to fetch
                          # ==========================================

                          # Docker Hub API base
                          baseUrl="https://registry.hub.docker.com/v2/repositories/${namespace}/${imageName}"
                          referenceUrl="${baseUrl}/tags/${referenceTag}"

                          echo "ðŸ“Œ Fetching reference tag '$referenceTag' info..."
                          referenceJson=$(curl -s "$referenceUrl")

                          if [[ -z "$referenceJson" || "$referenceJson" == *"Not Found"* ]]; then
                              echo "âŒ Failed to fetch tag '$referenceTag'"
                              echo "HARNESS_OUTPUT_VAR=No reference tag found" >> $HARNESS_OUTPUT_FILE
                              exit 1
                          fi

                          referenceLastUpdated=$(echo "$referenceJson" | jq -r '.last_updated')
                          echo "ðŸ“Œ '$referenceTag' last updated at: $referenceLastUpdated"
                          echo

                          # 2. Fetch latest tags
                          tagsUrl="${baseUrl}/tags?page_size=${pageSize}&ordering=last_updated"
                          tagsJson=$(curl -s "$tagsUrl")

                          if [[ -z "$tagsJson" || "$tagsJson" == *"error"* ]]; then
                              echo "âŒ Failed to fetch tags list."
                              echo "HARNESS_OUTPUT_VAR=Failed to fetch tags" >> $HARNESS_OUTPUT_FILE
                              exit 1
                          fi

                          # 3. Filter and display tags updated after reference
                          results=""
                          while read -r tag; do
                              tagName=$(echo "$tag" | jq -r '.name')
                              tagUpdated=$(echo "$tag" | jq -r '.last_updated')

                              if [[ "$tagUpdated" > "$referenceLastUpdated" ]]; then
                                  results+="ðŸ†• $tagName â€” Updated at: $tagUpdated\n"
                              fi
                          done < <(echo "$tagsJson" | jq -c '.results[]')

                          if [[ -z "$results" ]]; then
                              results="No new tags found after $referenceTag"
                          fi

                          # Export result so Harness can pick it up
                          echo "HARNESS_OUTPUT_VAR=$results" >> $HARNESS_OUTPUT_FILE
                    environmentVariables: []
                    outputVariables:
                      - name: TAG_CHECK_OUTPUT
                        type: String
                        value: HARNESS_OUTPUT_VAR
                    executionTarget: {}
                  timeout: 10m
              - step:
                  type: Email
                  name: SendEmailNotification
                  identifier: SendEmailNotification
                  spec:
                    to: tonystark143225@gmail.com
                    subject: New Docker Tags for MySQL
                    body: |
                      Hello Team,

                      The following Docker tags were checked against reference tag **8.0**:

                      <+pipeline.stages.Check_Docker_Tags.spec.execution.steps.RunTagCheckScript.output.outputVariables.TAG_CHECK_OUTPUT>

                      Regards,
                      Harness Pipeline
