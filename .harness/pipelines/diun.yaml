pipeline:
  name: diun
  identifier: diun
  projectIdentifier: appattendance
  orgIdentifier: default
  tags: {}
  stages:
    - stage:
        name: Check_Docker_Tags
        identifier: Check_Docker_Tags
        description: Check for new MySQL Docker tags and notify via email
        type: Custom
        spec:
          execution:
            steps:
              - step:
                  type: ShellScript
                  name: RunTagCheckScript
                  identifier: RunTagCheckScript
                  spec:
                    shell: Bash
                    source:
                      type: Inline
                      spec:
                        script: |
                          #!/bin/bash

                          # ========= Install jq if missing =========
                          if ! command -v jq &> /dev/null; then
                            echo "📦 Installing jq..."
                            if command -v microdnf &> /dev/null; then
                              microdnf install -y jq
                            elif command -v dnf &> /dev/null; then
                              dnf install -y jq
                            else
                              yum install -y jq
                            fi
                          fi

                          #!/bin/bash

                          # ========= Configurable Variables =========
                          # Format: image|namespace|referenceTag
                          images=(
                            "mysql|library|8.0"
                            "redis|library|7.0"
                            "nginx|library|1.25"
                          )

                          pageSize=100  # Number of tags to fetch
                          # ==========================================

                          for entry in "${images[@]}"; do
                              IFS='|' read -r imageName namespace referenceTag <<< "$entry"

                              echo "========================================="
                              echo "🔍 Checking image: ${namespace}/${imageName}"
                              echo "➡️  Reference tag: $referenceTag"
                              
                              # Docker Hub API base
                              baseUrl="https://registry.hub.docker.com/v2/repositories/${namespace}/${imageName}"

                              # 1. Get last_updated of reference tag
                              referenceUrl="${baseUrl}/tags/${referenceTag}"
                              referenceJson=$(curl -s "$referenceUrl")

                              if [[ -z "$referenceJson" || "$referenceJson" == *"Not Found"* ]]; then
                                  echo "❌ Failed to fetch tag '$referenceTag'"
                                  continue
                              fi

                              referenceLastUpdated=$(echo "$referenceJson" | jq -r '.last_updated')
                              echo "📌 '$referenceTag' last updated at: $referenceLastUpdated"
                              echo

                              # 2. Fetch latest tags
                              tagsUrl="${baseUrl}/tags?page_size=${pageSize}&ordering=last_updated"
                              tagsJson=$(curl -s "$tagsUrl")

                              if [[ -z "$tagsJson" || "$tagsJson" == *"error"* ]]; then
                                  echo "❌ Failed to fetch tags list."
                                  continue
                              fi

                              # 3. Filter and display tags updated after reference
                              echo "📈 Tags updated after '$referenceTag':"
                              found=false

                              while read -r tag; do
                                  tagName=$(echo "$tag" | jq -r '.name')
                                  tagUpdated=$(echo "$tag" | jq -r '.last_updated')

                                  if [[ "$tagUpdated" > "$referenceLastUpdated" ]]; then
                                      echo "🆕 $tagName — Updated at: $tagUpdated"
                                      found=true
                                  fi
                              done < <(echo "$tagsJson" | jq -c '.results[]')

                              [[ "$found" != "true" ]] && echo "✅ No newer tags found."
                              echo
                          done
                    environmentVariables: []
                    outputVariables:
                      - name: TAG_CHECK_OUTPUT
                        type: String
                        value: HARNESS_OUTPUT_VAR
                    executionTarget: {}
                  timeout: 10m
              - step:
                  type: Email
                  name: SendEmailNotification
                  identifier: SendEmailNotification
                  spec:
                    to: tonystark143225@gmail.com
                    subject: New Docker Tags for MySQL
                    body: |
                      Hello Team,

                      The following Docker tags were checked against reference tag **8.0**:

                      <+pipeline.stages.Check_Docker_Tags.spec.execution.steps.RunTagCheckScript.output.outputVariables.TAG_CHECK_OUTPUT>

                      Regards,
                      Harness Pipeline
